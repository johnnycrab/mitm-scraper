// Generated by CoffeeScript 1.6.3
var Blacklist, Canvas, EmailCoverTransformer, EmailCredentialsTransformer, EmailTransformer, Handlebars, PageTransformer, TemplateTransformer, Templates, WebpageCoverTransformer, WebpageCredentialsTransformer, WebpageTransformer, app, cheerio, express, fav, fs, hbTemplates, httpGet, incSequenceNumber, io, precompileTemplates, redis, redisClient, redisClient2, request, sequenceNumber, server, subterfuge_css_loc, subterfuge_image_loc, _ref, _ref1, _ref2, _ref3, _ref4, _ref5,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

subterfuge_image_loc = 'http://localhost:4000/static/scraper/images/';

subterfuge_css_loc = 'http://localhost:4000/static/scraper/css/';

express = require('express');

redis = require('redis');

cheerio = require('cheerio');

Handlebars = require('handlebars');

Blacklist = require('./blacklist');

fs = require('fs');

request = require('request');

Canvas = require('canvas');

fav = require('fav')(Canvas);

httpGet = require('http-get');

app = express();

server = require('http').createServer(app);

io = require('socket.io').listen(server);

redisClient = redis.createClient(6379, "127.0.0.1");

redisClient2 = redis.createClient(6379, "127.0.0.1");

redisClient.on('error', function(err) {
  return console.log("REDIS ERROR: " + err);
});

server.listen(3000);

app.configure(function() {
  return app.use(express["static"](__dirname + '/public'));
});

Templates = {};

hbTemplates = {
  'webpage_cover': 'webpage_cover.html',
  'webpage_credentials': 'webpage_credentials.html',
  'email_cover': 'email_cover.html',
  'email_credentials': 'email_credentials.html',
  'email_body': 'email_body.html'
};

precompileTemplates = function() {
  var name, path, _results;
  _results = [];
  for (name in hbTemplates) {
    path = hbTemplates[name];
    _results.push((function(name) {
      return fs.readFile(__dirname + '/views/' + path, 'utf8', function(err, data) {
        if (err) {
          throw err;
        }
        return Templates[name] = Handlebars.compile(data);
      });
    })(name));
  }
  return _results;
};

precompileTemplates();

sequenceNumber = fs.readFileSync(__dirname + '/seqnum', {
  encoding: 'utf-8'
});

sequenceNumber = sequenceNumber ? parseInt(sequenceNumber) : 0;

incSequenceNumber = function() {
  sequenceNumber++;
  fs.writeFile(__dirname + '/seqnum', sequenceNumber);
  return sequenceNumber;
};

io.sockets.on('connection', function(socket) {
  socket.on('ping', function() {
    return socket.emit('ready');
  });
  return socket.on('scrape', function(data) {
    var pageTransformer;
    data = JSON.parse(data);
    pageTransformer = new PageTransformer(data.page, data.host, data.fullUrl, data.title, data.encoding);
    return pageTransformer.run();
  });
});

redisClient.subscribe('new:credentials');

redisClient.subscribe('new:mail');

redisClient.subscribe('new:mail_credentials');

redisClient.on('message', function(channel, message) {
  var dataObj;
  dataObj = JSON.parse(message);
  if (dataObj) {
    if (channel === 'new:credentials') {
      return new WebpageCredentialsTransformer(dataObj).publish();
    } else if (channel === 'new:mail_credentials') {
      return new EmailCredentialsTransformer(dataObj).publish();
    } else if (channel === 'new:mail') {
      new EmailCoverTransformer(dataObj).publish();
      return new EmailTransformer(dataObj).publish();
    }
  }
});

TemplateTransformer = (function() {
  TemplateTransformer.prototype.type = null;

  function TemplateTransformer(obj) {
    this.obj = obj;
    this.t = {};
    this.t.DossierNr = incSequenceNumber();
    this.t.Timestamp = (new Date(this.obj.date)).toUTCString();
    this.process();
  }

  TemplateTransformer.prototype.getTemplateKey = function() {
    return this.type;
  };

  TemplateTransformer.prototype.process = function() {};

  TemplateTransformer.prototype.getPublishKey = function() {
    return 'new:printable:' + this.obj.date + '_' + this.type;
  };

  TemplateTransformer.prototype.stripHostname = function(hostname) {
    if (hostname) {
      return hostname.replace('.fritz.box', '');
    } else {
      return '';
    }
  };

  TemplateTransformer.prototype.publish = function() {
    console.log("Publishing printable data...s");
    return redisClient2.publish(this.getPublishKey(), Templates[this.getTemplateKey()](this.t), redis.print);
  };

  return TemplateTransformer;

})();

WebpageTransformer = (function(_super) {
  __extends(WebpageTransformer, _super);

  function WebpageTransformer() {
    _ref = WebpageTransformer.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  WebpageTransformer.prototype.process = function() {
    WebpageTransformer.__super__.process.call(this);
    this.t.DestIp = this.obj.DestIP;
    return this.t.SrcIp = this.obj.IP;
  };

  return WebpageTransformer;

})(TemplateTransformer);

EmailTransformer = (function(_super) {
  __extends(EmailTransformer, _super);

  function EmailTransformer() {
    _ref1 = EmailTransformer.__super__.constructor.apply(this, arguments);
    return _ref1;
  }

  EmailTransformer.prototype.type = 'email_body';

  EmailTransformer.prototype.process = function() {
    EmailTransformer.__super__.process.call(this);
    this.t.Subject = this.obj.subject;
    return this.t.Message = this.obj.message;
  };

  return EmailTransformer;

})(WebpageTransformer);

WebpageCoverTransformer = (function(_super) {
  __extends(WebpageCoverTransformer, _super);

  function WebpageCoverTransformer() {
    _ref2 = WebpageCoverTransformer.__super__.constructor.apply(this, arguments);
    return _ref2;
  }

  WebpageCoverTransformer.prototype.type = 'webpage_cover';

  WebpageCoverTransformer.prototype.images = {
    android: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4yLjEsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz4NCgk8Zz4NCgkJPHBhdGggZD0iTTM1MiwyMDh2NjAuNVYzNTdoLTIyLjVIMzEzdjE1LjVWNDI0YzAsNC40LTMsNy45LTcuMyw4bDAsMGwtMC4xLDBjLTAuMSwwLTAuMiwwLTAuMywwYy0xLjYsMC0zLjEtMC42LTQuMy0xLjZsLTAuMS0wLjENCgkJCWwtMC40LTAuMWMtMi0xLjYtMy40LTQtMy40LTYuMnYtNTEuNVYzNTdoLTE1LjVoLTQ5SDIxNnYxNS41VjQyNGMwLDQuNC0zLjYsOC04LDhzLTgtMy42LTgtOHYtNTEuNVYzNTdoLTE1LjVIMTYwdi04OC42VjIwOEgzNTINCgkJCSBNMzY4LDE5MkgxNDR2NzYuNFYzNThjMCw2LjksNS41LDE1LDEyLjQsMTVIMTg0djUxYzAsMTMuMywxMC43LDI0LDI0LDI0czI0LTEwLjcsMjQtMjR2LTUxaDQ5djUxYzAsNy41LDMuOSwxNC4yLDkuMywxOC42DQoJCQljMy45LDMuNCw5LjMsNS40LDE1LDUuNGMwLjEsMCwwLjMsMCwwLjQsMGMwLjEsMC0wLjMsMC0wLjIsMGMxMy4zLDAsMjMuNi0xMC43LDIzLjYtMjR2LTUxaDI4LjZjNywwLDEwLjQtOC4xLDEwLjQtMTQuOXYtODkuNg0KCQkJVjE5MkwzNjgsMTkyeiIvPg0KCQk8cGF0aCBkPSJNNDA4LDE5MmM0LjQsMCw4LDMuNiw4LDh2OTZjMCw0LjQtMy42LDgtOCw4cy04LTMuNi04LTh2LTk2QzQwMCwxOTUuNiw0MDMuNiwxOTIsNDA4LDE5MiBNNDA4LDE3NmMtMTMuMywwLTI0LDEwLjctMjQsMjQNCgkJCXY5NmMwLDEzLjMsMTAuNywyNCwyNCwyNHMyNC0xMC43LDI0LTI0di05NkM0MzIsMTg2LjcsNDIxLjMsMTc2LDQwOCwxNzZMNDA4LDE3NnoiLz4NCgkJPHBhdGggZD0iTTEwNCwxOTJjNC40LDAsOCwzLjYsOCw4djk2YzAsNC40LTMuNiw4LTgsOHMtOC0zLjYtOC04di05NkM5NiwxOTUuNiw5OS42LDE5MiwxMDQsMTkyIE0xMDQsMTc2Yy0xMy4zLDAtMjQsMTAuNy0yNCwyNA0KCQkJdjk2YzAsMTMuMywxMC43LDI0LDI0LDI0czI0LTEwLjcsMjQtMjR2LTk2QzEyOCwxODYuNywxMTcuMywxNzYsMTA0LDE3NkwxMDQsMTc2eiIvPg0KCTwvZz4NCgk8Zz4NCgkJPHBhdGggZD0iTTI1NSw5NC4zbDAuOSwwaDBoMGMxNC4yLDAsMjcuMywxLjksMzguOCw1LjZsMTAsNC40YzI4LjcsMTIuNiwzOS45LDM3LjQsNDQuNCw1NS43SDE2Mi44YzQuNC0xOC42LDE1LjYtNDMuNiw0NC4xLTU2DQoJCQlsMTAuMy00LjVDMjI4LjUsOTYuMSwyNDEuMiw5NC4zLDI1NSw5NC4zIE0xODUuNCw2NGMtMC41LDAtMS4yLDAuMi0xLjgsMC44Yy0xLjEsMC44LTEuNywxLjgtMS4zLDIuNWwxOC4zLDIyLjENCgkJCWMtNDguMiwyMC45LTU1LjQsNzEuNy01Ni40LDg2LjdoMjIzLjZjLTEuMS0xNS04LjItNjUuMS01Ni42LTg2LjRsMTguNS0yMi4yYzAuNC0wLjUtMC4yLTEuNy0xLjMtMi42Yy0wLjctMC41LTEuNS0wLjgtMi0wLjgNCgkJCWMtMC4zLDAtMC41LDAuMS0wLjcsMC4zbC0xOS4yLDIyLjdjLTEzLjYtNS40LTMwLjItOC44LTUwLjYtOC44Yy0wLjMsMC0wLjYsMC0xLDBjLTIwLDAtMzYuNCwzLjMtNDkuOCw4LjVsLTE5LTIyLjUNCgkJCUMxODYuMSw2NC4xLDE4NS44LDY0LDE4NS40LDY0TDE4NS40LDY0eiIvPg0KCTwvZz4NCjwvZz4NCjxwYXRoIGQ9Ik0yMDYuNiwxMzguOWMtNy40LDAtMTMuNS02LTEzLjUtMTMuM2MwLTcuMyw2LTEzLjMsMTMuNS0xMy4zYzcuNCwwLDEzLjUsNiwxMy41LDEzLjNDMjIwLjEsMTMyLjksMjE0LjEsMTM4LjksMjA2LjYsMTM4Ljl6DQoJIi8+DQo8cGF0aCBkPSJNMzA1LDEzOC45Yy03LjQsMC0xMy41LTYtMTMuNS0xMy4zYzAtNy4zLDYtMTMuMywxMy41LTEzLjNjNy40LDAsMTMuNSw2LDEzLjUsMTMuM0MzMTguNSwxMzIuOSwzMTIuNCwxMzguOSwzMDUsMTM4Ljl6Ii8+DQo8L3N2Zz4NCg==',
    apple: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4yLjEsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz4NCgk8cGF0aCBkPSJNMzMzLjYsMTY5LjljMTYuMywwLDMzLjIsNy40LDQ3LjQsMjAuNGMtOS45LDguNS0xNy45LDE4LjctMjMuNywzMC4yYy04LDE2LTExLjYsMzQuMy0xMC4yLDUyLjcNCgkJYzEuMywxOC43LDcuNiwzNi42LDE4LDUxLjhjOCwxMS42LDE4LjIsMjEuMiwzMCwyOC4zYy01LDEwLjctOS4yLDE4LjQtMTYuOCwzMC41Yy04LjQsMTMuMS0zMC41LDQ4LTUyLDQ4LjJsLTAuNCwwDQoJCWMtNy40LDAtMTIuMi0yLjItMTkuMy01LjZjLTEwLTQuNy0yMi4zLTEwLjYtNDMuNC0xMC42bC0wLjYsMGMtMjEuMSwwLjEtMzMuOCw1LjktNDMuOSwxMC42Yy03LjQsMy40LTEyLjMsNS43LTE5LjksNS43bC0wLjQsMA0KCQljLTE5LjYtMC4yLTM3LjUtMjQuMy01MC44LTQ1LjJjLTE5LjMtMzAuNC0zMS43LTY1LjYtMzQuOS05OS4xYy0yLjktMzAuNSwyLTU4LjUsMTMuNS03Ni43YzgtMTIuNywxOC41LTIzLjMsMzAuNC0zMC42DQoJCWMxMS4yLTYuOCwyMy0xMC40LDM0LjItMTAuNGMxMi40LDAsMjIuNywzLjgsMzMuNyw3LjhjMTEuNSw0LjIsMjMuNSw4LjYsMzcuNyw4LjZjMTMuNiwwLDI0LjMtNC4yLDM0LjYtOC4yDQoJCUMzMDgsMTczLjksMzE4LjIsMTY5LjksMzMzLjYsMTY5LjkgTTMzMy42LDE1My45Yy0zMy42LDAtNDcuOCwxNi41LTcxLjIsMTYuNWMtMjQsMC00Mi4zLTE2LjQtNzEuNC0xNi40DQoJCWMtMjguNSwwLTU4LjksMTcuOS03OC4yLDQ4LjRjLTI3LjEsNDMtMjIuNSwxMjQsMjEuNCwxOTNjMTUuNywyNC43LDM2LjcsNTIuNCw2NC4yLDUyLjdjMC4yLDAsMC4zLDAsMC41LDANCgkJYzIzLjksMCwzMS0xNi4xLDYzLjktMTYuM2MwLjIsMCwwLjMsMCwwLjUsMGMzMi40LDAsMzguOSwxNi4yLDYyLjcsMTYuMmMwLjIsMCwwLjMsMCwwLjUsMGMyNy41LTAuMyw0OS42LTMxLDY1LjMtNTUuNg0KCQljMTEuMy0xNy43LDE1LjUtMjYuNiwyNC4yLTQ2LjZjLTYzLjUtMjQuOC03My43LTExNy40LTEwLjktMTUyLjlDMzg1LjksMTY4LjIsMzU5LDE1My45LDMzMy42LDE1My45TDMzMy42LDE1My45eiIvPg0KCTxwYXRoIGQ9Ik0zMDkuOSw4NC41Yy0yLjcsMTQuOS0xMC41LDI2LjgtMTQuNiwzMi4yYy03LjQsOS44LTE4LDE3LjQtMjguOCwyMS4xYzAuNS0zLDEuMy02LjEsMi40LTkuMmMzLjUtMTAuMiw4LjktMTguMiwxMi44LTIzLjENCgkJQzI4OC44LDk2LjcsMjk5LjMsODkuMSwzMDkuOSw4NC41IE0zMjYuMiw2NGMtMjAsMS40LTQzLjMsMTQuNS01NywzMS42Yy0xMi40LDE1LjUtMjIuNiwzOC41LTE4LjYsNjAuOGMwLjUsMCwxLDAsMS42LDANCgkJYzIxLjMsMCw0My4xLTEzLjIsNTUuOC0zMC4xQzMyMC4zLDExMC4yLDMyOS42LDg3LjQsMzI2LjIsNjRMMzI2LjIsNjR6Ii8+DQo8L2c+DQo8L3N2Zz4NCg==',
    windows: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4yLjEsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz4NCgk8cGF0aCBkPSJNMTk5LjksMjgyLjd2MTA1LjVsLTAuOC0wLjFMOTUuOCwzNjcuM3YtODQuNkgxOTkuOSBNMjAyLjEsMjY2LjdIOTMuNGMtNy40LDAtMTMuNCw2LjEtMTMuNCwxMy43djg5DQoJCWMwLDYuNiw0LjYsMTEuOSwxMC43LDEzLjJsMTA1LjQsMjEuMWw2LjksMS4yYzctMC4zLDEyLjctNi40LDEyLjctMTMuNVYyODAuNEMyMTUuNywyNzIuNywyMDkuNSwyNjYuNywyMDIuMSwyNjYuN0wyMDIuMSwyNjYuN3oiDQoJCS8+DQoJPHBhdGggZD0iTTQxNi4yLDI4Mi43djE0Ny4ybC0yLjEsMS4xbC0xNjAuNC0zMmwtMS0wLjJ2LTExNkg0MTYuMiBNNDE4LjQsMjY2LjdIMjUwLjJjLTcuNCwwLTEzLjQsNi4xLTEzLjQsMTMuN3YxMjAuNXYwLjINCgkJYzAsNS41LDMuMywxMC4xLDcuOSwxMi4yYzAuMiwwLjIsMC4yLDAuMiwwLjIsMC4ybDUuMywxLjFjMC4yLDAsMC4yLDAsMC4zLDBsMTY0LjcsMzIuOWMwLjIsMC4xLDAuNSwwLjMsMC43LDAuMw0KCQljMC4xLDAsMC4yLDAsMC4zLTAuMWMwLjcsMC40LDEuNCwwLjQsMi4xLDAuNGM3LjQsMCwxMy42LTYsMTMuNi0xMy41VjI4MC40QzQzMiwyNzIuNyw0MjUuOCwyNjYuNyw0MTguNCwyNjYuN0w0MTguNCwyNjYuN3oiLz4NCgk8cGF0aCBkPSJNNDE0LDgxLjFsMi4xLDEuMXYxNDcuMkgyNTIuNnYtMTE2bDEtMC4yTDQxNCw4MS4xIE00MTguNCw2NGMtMC43LDAtMS40LDAtMi4xLDAuNGMtMC4xLTAuMS0wLjItMC4xLTAuMy0wLjENCgkJYy0wLjIsMC0wLjUsMC4xLTAuNywwLjNMMjUwLjUsOTcuNGMtMC4yLDAtMC4yLDAtMC4zLDBsLTUuMSwxLjFjMCwwLTAuMiwwLTAuNCwwLjJjLTQuNiwyLjEtNy45LDYuOS03LjksMTIuNHYxMjAuNQ0KCQljMCw3LjYsNiwxMy43LDEzLjQsMTMuN2gxNjguMmM3LjQsMCwxMy42LTYuMSwxMy42LTEzLjdWNzcuNUM0MzIsNzAuMSw0MjUuOCw2NCw0MTguNCw2NEw0MTguNCw2NHoiLz4NCgk8cGF0aCBkPSJNMTk5LjksMTIzLjl2MTA1LjVIOTUuOHYtODQuNkwxOTkuMSwxMjRMMTk5LjksMTIzLjkgTTIwMywxMDdsLTYuOSwxLjJMOTAuNywxMjkuNEM4NC42LDEzMC43LDgwLDEzNiw4MCwxNDIuNnY4OQ0KCQljMCw3LjYsNiwxMy43LDEzLjQsMTMuN2gxMDguOGM3LjQsMCwxMy42LTYuMSwxMy42LTEzLjdWMTIwLjVDMjE1LjcsMTEzLjQsMjEwLjEsMTA3LjQsMjAzLDEwN0wyMDMsMTA3eiIvPg0KPC9nPg0KPC9zdmc+DQo='
  };

  WebpageCoverTransformer.prototype.process = function() {
    WebpageCoverTransformer.__super__.process.call(this);
    console.log(this.obj);
    console.log(this.t);
    this.t.FaviconSrc = this.obj.faviconSrc;
    this.t.OsImage = this.getOsImage();
    this.t.Title = this.obj.title;
    this.t.Link = this.obj.fullUrl;
    this.t.HostName = this.stripHostname(this.obj.Hostname);
    return this.t.UAgent = this.obj.UAgent;
  };

  WebpageCoverTransformer.prototype.getOsImage = function() {
    var os, uagent;
    os = '';
    uagent = this.obj.UAgent;
    if (uagent) {
      if (uagent.indexOf('Android') !== -1) {
        os = 'android';
      }
      if (uagent.indexOf('Mac') !== -1) {
        os = 'apple';
      }
      if (uagent.indexOf('Win') !== -1) {
        os = 'windows';
      }
    }
    if (this.images[os]) {
      return this.images[os];
    } else {
      return '';
    }
  };

  return WebpageCoverTransformer;

})(WebpageTransformer);

WebpageCredentialsTransformer = (function(_super) {
  __extends(WebpageCredentialsTransformer, _super);

  function WebpageCredentialsTransformer() {
    _ref3 = WebpageCredentialsTransformer.__super__.constructor.apply(this, arguments);
    return _ref3;
  }

  WebpageCredentialsTransformer.prototype.type = 'webpage_credentials';

  WebpageCredentialsTransformer.prototype.process = function() {
    WebpageCredentialsTransformer.__super__.process.call(this);
    this.t.HostName = this.obj.source;
    this.t.Value = this.obj.username;
    return this.t.Password = this.obj.password;
  };

  return WebpageCredentialsTransformer;

})(WebpageTransformer);

EmailCoverTransformer = (function(_super) {
  __extends(EmailCoverTransformer, _super);

  function EmailCoverTransformer() {
    _ref4 = EmailCoverTransformer.__super__.constructor.apply(this, arguments);
    return _ref4;
  }

  EmailCoverTransformer.prototype.type = 'email_cover';

  EmailCoverTransformer.prototype.process = function() {
    EmailCoverTransformer.__super__.process.call(this);
    this.t.DestEmail = this.obj.to;
    this.t.SrcEmail = this.obj.from;
    this.t.HostName = this.stripHostname(this.obj.hostname);
    this.t.UAgent = this.obj.mailclient;
    return console.log(this.obj);
  };

  return EmailCoverTransformer;

})(EmailTransformer);

EmailCredentialsTransformer = (function(_super) {
  __extends(EmailCredentialsTransformer, _super);

  function EmailCredentialsTransformer() {
    _ref5 = EmailCredentialsTransformer.__super__.constructor.apply(this, arguments);
    return _ref5;
  }

  EmailCredentialsTransformer.prototype.type = 'email_credentials';

  EmailCredentialsTransformer.prototype.process = function() {
    EmailCredentialsTransformer.__super__.process.call(this);
    this.t.HostName = this.stripHostname(this.obj.hostname);
    this.t.UserName = this.obj.username;
    this.t.Password = this.obj.password;
    return console.log(this.obj);
  };

  return EmailCredentialsTransformer;

})(EmailTransformer);

PageTransformer = (function() {
  function PageTransformer(data, host, fullUrl, title, encoding) {
    this.host = host;
    this.fullUrl = fullUrl;
    this.title = title;
    this.encoding = encoding;
    this.html = '<!DOCTYPE html><html>' + data + '</html>';
    this.$ = cheerio.load(this.html);
    this.timestamp = new Date().getTime();
  }

  PageTransformer.prototype.run = function() {
    console.log(Blacklist["do"](this));
    if (!Blacklist["do"](this)) {
      this.getConnectionInfos();
      this.removeScripts();
      this.changeImageSources();
      this.changeCSSSources();
      return this.save();
    }
  };

  PageTransformer.prototype.removeScripts = function() {
    return this.$('script').remove();
  };

  PageTransformer.prototype.substituteSlashes = function(selector, attrName, new_path) {
    var $, that;
    $ = this.$;
    that = this;
    return $(selector).each(function() {
      var attr, newHost, re;
      attr = $(this).attr(attrName);
      newHost = '';
      if (attr) {
        if (attr.indexOf('http://') !== 0) {
          newHost = that.host + (attr.indexOf('/') === 0 ? '' : '/') + attr;
        } else {
          newHost = attr.replace('http://', '');
        }
        re = new RegExp('/', 'g');
        newHost = new_path + newHost.replace(re, '_');
        return $(this).attr(attrName, newHost);
      }
    });
  };

  PageTransformer.prototype.changeImageSources = function() {
    return this.substituteSlashes('img', 'src', subterfuge_image_loc);
  };

  PageTransformer.prototype.changeCSSSources = function() {
    return this.substituteSlashes('link[rel=stylesheet]', 'href', subterfuge_css_loc);
  };

  PageTransformer.prototype.getFaviconSrc = function(cb) {
    var checkAndContinue, i, opts, possibleExtensions, re,
      _this = this;
    possibleExtensions = ['ico', 'png', 'gif', 'jpg', 'jpeg'];
    re = new RegExp('/', 'g');
    i = -1;
    opts = {
      hostname: this.host,
      port: 80,
      method: 'GET'
    };
    checkAndContinue = function() {
      var full_path, full_path_png, uri, uri_safe;
      i++;
      if (i <= possibleExtensions.length) {
        opts.path = '/favicon.' + possibleExtensions[i];
        uri = 'http://' + opts.hostname + opts.path;
        uri_safe = uri.replace(re, '_');
        full_path = __dirname + '/favicons/' + uri_safe;
        full_path_png = full_path + '.png';
        return fs.exists(full_path_png, function(exists) {
          if (exists) {
            return cb('file://' + full_path_png);
          } else {
            return httpGet.get({
              url: uri
            }, full_path, function(err, result) {
              var e, icon;
              if (err) {
                return checkAndContinue();
              } else {
                try {
                  icon = fav(full_path).getLargest();
                  icon.createPNGStream().pipe(fs.createWriteStream(full_path_png));
                  cb('file://' + full_path_png);
                } catch (_error) {
                  e = _error;
                  console.log(e);
                  checkAndContinue();
                }
                return fs.unlink(full_path);
              }
            });
          }
        });
      } else {
        return cb(null);
      }
    };
    return checkAndContinue();
  };

  PageTransformer.prototype.getConnectionInfos = function() {
    var $, connInfo, connÍnfo, jsonTag;
    $ = this.$;
    jsonTag = $('#mitm-scraper-conn-info');
    if (jsonTag.length) {
      connInfo = JSON.parse(jsonTag.html());
      connÍnfo = connInfo || {};
      connInfo.fullUrl = this.fullUrl;
      connInfo.title = this.title;
      connInfo.date = this.timestamp;
      return this.getFaviconSrc(function(src) {
        connInfo.faviconSrc = src;
        return new WebpageCoverTransformer(connInfo).publish();
      });
    }
  };

  PageTransformer.prototype.save = function() {
    var publishName;
    publishName = 'new:printable:' + this.timestamp + (this.encoding ? '#' + this.encoding : '');
    return redisClient2.publish(publishName, this.$.html(), redis.print);
  };

  return PageTransformer;

})();
